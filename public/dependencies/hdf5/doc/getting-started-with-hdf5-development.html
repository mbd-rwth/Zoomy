<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>getting-started-with-hdf5-development</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../docs/images/logo_mbd.png" alt="" class="navbar-logo">
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#getting-started-with-hdf5-development" id="toc-getting-started-with-hdf5-development" class="nav-link active" data-scroll-target="#getting-started-with-hdf5-development">Getting Started with HDF5 Development</a>
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started">Getting started</a>
  <ul class="collapse">
  <li><a href="#building-the-library-for-development" id="toc-building-the-library-for-development" class="nav-link" data-scroll-target="#building-the-library-for-development">Building the library for development</a></li>
  <li><a href="#branches" id="toc-branches" class="nav-link" data-scroll-target="#branches">Branches</a></li>
  <li><a href="#pull-requests" id="toc-pull-requests" class="nav-link" data-scroll-target="#pull-requests">Pull requests</a></li>
  </ul></li>
  <li><a href="#a-brief-tour-of-the-source-code" id="toc-a-brief-tour-of-the-source-code" class="nav-link" data-scroll-target="#a-brief-tour-of-the-source-code">A brief tour of the source code</a></li>
  <li><a href="#general-things" id="toc-general-things" class="nav-link" data-scroll-target="#general-things">General Things</a>
  <ul class="collapse">
  <li><a href="#necessary-software" id="toc-necessary-software" class="nav-link" data-scroll-target="#necessary-software">Necessary software</a></li>
  <li><a href="#platform-independence" id="toc-platform-independence" class="nav-link" data-scroll-target="#platform-independence">Platform-independence</a></li>
  <li><a href="#c99" id="toc-c99" class="nav-link" data-scroll-target="#c99">C99</a></li>
  <li><a href="#posix" id="toc-posix" class="nav-link" data-scroll-target="#posix">POSIX</a></li>
  <li><a href="#threads" id="toc-threads" class="nav-link" data-scroll-target="#threads">Threads</a></li>
  <li><a href="#c" id="toc-c" class="nav-link" data-scroll-target="#c">C++</a></li>
  <li><a href="#fortran" id="toc-fortran" class="nav-link" data-scroll-target="#fortran">Fortran</a></li>
  <li><a href="#java" id="toc-java" class="nav-link" data-scroll-target="#java">Java</a></li>
  <li><a href="#warning-suppression" id="toc-warning-suppression" class="nav-link" data-scroll-target="#warning-suppression">Warning suppression</a></li>
  </ul></li>
  <li><a href="#build-systems" id="toc-build-systems" class="nav-link" data-scroll-target="#build-systems">Build Systems</a></li>
  <li><a href="#working-in-the-library" id="toc-working-in-the-library" class="nav-link" data-scroll-target="#working-in-the-library">Working in the library</a>
  <ul class="collapse">
  <li><a href="#anatomy-of-an-hdf5-api-call" id="toc-anatomy-of-an-hdf5-api-call" class="nav-link" data-scroll-target="#anatomy-of-an-hdf5-api-call">Anatomy of an HDF5 API call</a></li>
  <li><a href="#public-private-package" id="toc-public-private-package" class="nav-link" data-scroll-target="#public-private-package">Public, private, package</a></li>
  <li><a href="#function-enter-and-leave-macros" id="toc-function-enter-and-leave-macros" class="nav-link" data-scroll-target="#function-enter-and-leave-macros">Function enter and leave macros</a></li>
  <li><a href="#error-macros" id="toc-error-macros" class="nav-link" data-scroll-target="#error-macros">Error macros</a></li>
  <li><a href="#trace-macros" id="toc-trace-macros" class="nav-link" data-scroll-target="#trace-macros">Trace macros</a></li>
  <li><a href="#memory---h5mm-and-h5fl" id="toc-memory---h5mm-and-h5fl" class="nav-link" data-scroll-target="#memory---h5mm-and-h5fl">Memory - <code>H5MM</code> and <code>H5FL</code></a></li>
  </ul></li>
  <li><a href="#testing" id="toc-testing" class="nav-link" data-scroll-target="#testing">Testing</a>
  <ul class="collapse">
  <li><a href="#two-macro-schemes" id="toc-two-macro-schemes" class="nav-link" data-scroll-target="#two-macro-schemes">Two macro schemes</a></li>
  <li><a href="#testhdf5.h" id="toc-testhdf5.h" class="nav-link" data-scroll-target="#testhdf5.h"><code>testhdf5.h</code></a></li>
  <li><a href="#h5test.h" id="toc-h5test.h" class="nav-link" data-scroll-target="#h5test.h"><code>h5test.h</code></a></li>
  <li><a href="#scripts" id="toc-scripts" class="nav-link" data-scroll-target="#scripts">Scripts</a></li>
  <li><a href="#parallel-tests-in-testpar" id="toc-parallel-tests-in-testpar" class="nav-link" data-scroll-target="#parallel-tests-in-testpar">Parallel tests (in <code>testpar/</code>)</a></li>
  <li><a href="#adding-new-tests" id="toc-adding-new-tests" class="nav-link" data-scroll-target="#adding-new-tests">Adding new tests</a></li>
  </ul></li>
  <li><a href="#documentation" id="toc-documentation" class="nav-link" data-scroll-target="#documentation">Documentation</a></li>
  <li><a href="#command-line-tools" id="toc-command-line-tools" class="nav-link" data-scroll-target="#command-line-tools">Command-Line Tools</a>
  <ul class="collapse">
  <li><a href="#source-code" id="toc-source-code" class="nav-link" data-scroll-target="#source-code">Source code</a></li>
  <li><a href="#tools-tests" id="toc-tools-tests" class="nav-link" data-scroll-target="#tools-tests">Tools tests</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">




<section id="getting-started-with-hdf5-development" class="level1">
<h1>Getting Started with HDF5 Development</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The purpose of this document is to introduce new HDF5 developers to some of the quirks of our source code. It’s not a style guide (see the forthcoming HDF5 style guide for that), but instead describes the most commonly encountered features that are likely to trip up someone who has never worked with the HDF5 source code before.</p>
<p>Corrections and suggestions for improvement should be handled via GitHub pull requests and issues.</p>
</section>
<section id="getting-started" class="level2">
<h2 class="anchored" data-anchor-id="getting-started">Getting started</h2>
<section id="building-the-library-for-development" class="level3">
<h3 class="anchored" data-anchor-id="building-the-library-for-development">Building the library for development</h3>
<p>You don’t really need special configuration settings for building the library as a developer.</p>
<p>Some tips that may be useful:</p>
<ul>
<li>Building in debug mode will turn on additional checks in many packages. You’ll probably want to start coding in debug mode.</li>
<li>You can turn symbols on independently of debug/production mode.</li>
<li>If you will be looking at memory issues via tools like valgrind, you will need to turn off the free lists, which recycle memory so we can avoid calling malloc/free. This is done using the <code>--enable-using-memchecker</code> configure option. Some developers build with this all the time, as the memory recyclilng can hide problems like use-after-free.</li>
<li>You can enable developer warnings via <code>--enable-developer-warnings</code>. These warnings generate a lot of noise, but the output can occasionally be useful. I probably wouldn’t turn them on all the time, though, as they can make it harder to spot warnings that we care about.</li>
<li>You can set warnings as errors. We have an older scheme that does this for a subset of errors or you can simply specify <code>-Werror</code>, etc. as a part of <code>CFLAGS</code>. Configure is smart enough to strip it out when it runs configure checks. We build the C library with -Werror on GitHub, so you’ll need to fix your warnings before creating a pull request.</li>
<li>CMake has a developer mode that turns most these settings on.</li>
</ul>
</section>
<section id="branches" class="level3">
<h3 class="anchored" data-anchor-id="branches">Branches</h3>
<p>Please see <code>doc/branches-explained.md</code> for an explanation of our branching strategy.</p>
<p>For new small features, we have developers create feature branches in their own repositories and then create pull requests into the canonical HDF5 repository. For larger work, especially when the work will be done by multiple people, we create feature branches named <code>feature/&lt;feature&gt;</code>. If work stops on a feature branch, we rename it to <code>inactive/&lt;feature&gt;</code>.</p>
<p>If you create a feature branch in the canonical HDFGroup repository, please create a <code>BRANCH.md</code> text file in the repository root and explain:</p>
<ul>
<li>The branch’s purpose</li>
<li>Contact info for someone who can tell us about the branch</li>
<li>Clues about when the branch will be merged or can be considered for retirement</li>
</ul>
<p>The purpose of this document is to avoid orphan branches with no clear provenance.</p>
</section>
<section id="pull-requests" class="level3">
<h3 class="anchored" data-anchor-id="pull-requests">Pull requests</h3>
<p>The process of creating a pull request is explained in <code>CONTRIBUTING.md</code>.</p>
</section>
</section>
<section id="a-brief-tour-of-the-source-code" class="level2">
<h2 class="anchored" data-anchor-id="a-brief-tour-of-the-source-code">A brief tour of the source code</h2>
<p>Here’s a quick guide to where you can find things in our source tree. Some of these directories have README.md files of their own.</p>
<p><code>bin/</code> Scripts we use for building the software and misc. tools.</p>
<p><code>c++/</code> Source, tests, and examples for the C++ language wrapper.</p>
<p><code>config/</code> Configuration files for both the Autotools and CMake.</p>
<p><code>doc/</code> Miscellaneous documents, mostly in markdown format.</p>
<p><code>doxygen/</code> Mainly Doxygen build files and other top-level Doxygen things. The Doxygen content is spread across the library’s header files but some content can be found here when it has no other obvious home.</p>
<p><code>examples/</code> C library examples. Fortran and C++ examples are located in their corresponding wrapper directory.</p>
<p><code>fortran/</code> Source, tests, and examples for the Fortran language wrapper.</p>
<p><code>hl/</code> Source, tests, and examples for the high-level library.</p>
<p><code>java/</code> Source, tests, and examples for the JNI language wrapper and the corresponding OO Java library.</p>
<p><code>m4/</code> m4 build scripts used by the Autotools. CMake ignores these.</p>
<p><code>release_docs/</code> Install instructions and release notes.</p>
<p><code>src/</code> Source code for the C library.</p>
<p><code>test/</code> C library test code. Described in much more detail below.</p>
<p><code>testpar/</code> Parallel C library test code. Described in much more detail below.</p>
<p><code>tools/</code> HDF5 command-line tools code, associated tools tests, and the input test files.</p>
<p><code>utils/</code> Small utility programs that don’t belong anywhere else.</p>
</section>
<section id="general-things" class="level2">
<h2 class="anchored" data-anchor-id="general-things">General Things</h2>
<section id="necessary-software" class="level3">
<h3 class="anchored" data-anchor-id="necessary-software">Necessary software</h3>
<p>In order to do development work on the HDF5 library, you will need to have a few things available.</p>
<ul>
<li>A C99-compatible C compiler (MSVC counts). C11 is required to build the subfiling feature.</li>
<li>Either CMake or the Autotools (Autoconf, Automake, libtool)</li>
<li>Perl is needed to run some scripts, even on Windows</li>
<li>A C++11-compatible compiler if you want to build the C++ wrappers</li>
<li>A Fortran 2003-compatible compiler if you want to build the Fortran wrappers</li>
<li>A Java 8-compatible compiler if you want to build the Java wrappers</li>
<li>flex/lex and bison/yacc if you want to modify the high-level parsers</li>
<li>A development version of zlib is necessary for zlib compression</li>
<li>A development version of szip is necessary for szip compression</li>
<li>An MPI-3 compatible MPI library must be installed for parallel HDF5 development</li>
<li>clang-format is handy for formatting your code before submission to GitHub. The formatter will automatically update your PR if it’s mis-formatted, though, so this isn’t strictly necessary.</li>
<li>codespell is useful to identify spelling issues before submission to GitHub. The codespell action won’t automatically correct your code, but it will point out spelling errors, so this also isn’t strictly necessary.</li>
</ul>
<p>These are the requirements for working on the develop branch. Maintenance branches may relax the required versions somewhat. For example, HDF5 1.12 and earlier only require C++98.</p>
<p>Certain optional features may require additional libraries to be installed. You’ll need curl and some S3 components installed to build the read-only S3 VFD, for example.</p>
</section>
<section id="platform-independence" class="level3">
<h3 class="anchored" data-anchor-id="platform-independence">Platform-independence</h3>
<p>HDF5 assumes you have a C99 compiler and, to a certain extent, a POSIX-like environment (other languages will be discussed later). On most operating systems in common use, this will be a reasonable assumption. The biggest exception to this has been Windows, which, until recently, had poor C99 compliance and spotty POSIX functionality. To work around differences in platforms and compilers, we’ve implemented a compatibility scheme.</p>
<p>Unlike most codebases, which test for features and inject their own normal-looking functions when there are deficiencies, HDF5 uses a scheme where we prefix all C and POSIX calls with <code>HD</code> (e.g., <code>HDmalloc</code>). The <code>H5private.h</code> header handles most of the fixup for Unix-like operating systems and defines the HD replacements. For Windows, we first parse the <code>H5win32defs.h</code> file, which maps missing Windows and MSVC functionality to POSIX and C99 calls. <code>H5private.h</code> tests for previously defined HD calls and skips redefining it if it already exists. H5system.c includes Windows glue code as well as a few functions we need to paper over differences in Unix-like systems.</p>
<p>One thing to keep in mind when looking at our platform-independence layer is that it is quite old, having been authored when the Unix world was much more fragmented and C99 was uncommon. We’ve slowly been reworking it as POSIX has standardized and C99 become widespread.</p>
<p>Another thing to keep in mind is that we’re fairly conservative about deprecating support for older platforms and compilers. There’s an awful lot of ancient hardware that requires HDF5, so we try to only make major changes to things like language requirements when we increment the major version (minor version prior to HDF5 2.0).</p>
</section>
<section id="c99" class="level3">
<h3 class="anchored" data-anchor-id="c99">C99</h3>
<p>We assume you have a C99 compiler. Subfiling uses some C11 features, but that is compiled on demand and we are not moving that requirement to the rest of the library. All modern compilers we’ve tested can handle HDF5’s C99 requirements, even Microsoft’s. In the future, we’ll remove the <code>HD</code> prefixes from all standard C library calls.</p>
<p>One quirk of HDF5’s age, is the <code>hbool_t</code> type, which was created before C99 Booleans were widespread and which uses <code>TRUE</code> and <code>FALSE</code> macros for its values instead of C99’s <code>true</code> and <code>false</code>. We plan to switch this over to C99’s Boolean types sometime in the near future.</p>
</section>
<section id="posix" class="level3">
<h3 class="anchored" data-anchor-id="posix">POSIX</h3>
<p>We assume basic POSIX.1-2008 functionality is present. When a POSIX (or common Unix) function is missing on a popular platform, we implement a shim or macro in <code>H5private.h</code> and/or <code>H5system.c</code>. Systems that need a lot of help, like Windows, have gotten special headers in the past (e.g., <code>H5win32defs.h</code>) but now that most platforms implement the POSIX and C99 functionality we need, these special headers are less necessary.</p>
</section>
<section id="threads" class="level3">
<h3 class="anchored" data-anchor-id="threads">Threads</h3>
<p>Thread-safety was originally implemented using Pthreads, with Win32 support bolted on later. No other thread libraries are supported. The subfiling feature uses multiple threads under the hood, but that’s out of scope for an introductory document. Thread-related code is largely confined to the <code>H5TS</code> files, where we define HDF5-specific primitives and then map Pthread or Win32 implementations onto them.</p>
</section>
<section id="c" class="level3">
<h3 class="anchored" data-anchor-id="c">C++</h3>
<p>The C++ Wrappers require C++11. We generally only require the rule of three for the classes.</p>
</section>
<section id="fortran" class="level3">
<h3 class="anchored" data-anchor-id="fortran">Fortran</h3>
<p>The Fortran wrappers require Fortran 2003.</p>
</section>
<section id="java" class="level3">
<h3 class="anchored" data-anchor-id="java">Java</h3>
<p>The Java wrappers require Java 8.</p>
</section>
<section id="warning-suppression" class="level3">
<h3 class="anchored" data-anchor-id="warning-suppression">Warning suppression</h3>
<p>In the rare cases where we’ve decided to suppress a warning, we have a set of function-like macros that we use for that. They are located in <code>H5private.h</code> and have the form <code>H5_&lt;compiler&gt;_DIAG_(OFF|ON)</code> and take the name of the warning they are suppressing as a parameter. They were originally designed for gcc and extended to clang. They have not been updated for other compilers. Instead, we have plans to revamp the macro system to be more generic and extensible.</p>
<p>We try to configure the compilers we use the most for maximum grumpiness and then fix all the warnings we can. Please don’t use the warning suppression macros in lieu of actually fixing the underlying problems.</p>
</section>
</section>
<section id="build-systems" class="level2">
<h2 class="anchored" data-anchor-id="build-systems">Build Systems</h2>
<p>We support building the library with both the Autotools and CMake. We’d like to eventually move to only having one build system, which would be CMake since the Autotools don’t really support Windows, but that seems unlikely to happen anytime soon. With few exceptions, any new feature, test, or configure option should be supported in both build systems.</p>
<p>The particulars of the build systems can be found in the <code>config</code> directory and its subdirectories.</p>
</section>
<section id="working-in-the-library" class="level2">
<h2 class="anchored" data-anchor-id="working-in-the-library">Working in the library</h2>
<section id="anatomy-of-an-hdf5-api-call" class="level3">
<h3 class="anchored" data-anchor-id="anatomy-of-an-hdf5-api-call">Anatomy of an HDF5 API call</h3>
<p>HDF5 API calls have a uniform structure imposed by our function enter/leave and error handling schemes. We currently stick to this boilerplate for ALL functions, though this may change in the future. The general boilerplate varies slightly between internal and public API calls.</p>
<p>Here’s an example of an internal API call:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Function comments of dubious value</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>herr_t</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>H5X_do_stuff<span class="op">(</span><span class="co">/*parameters*/</span><span class="op">)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* variables go here */</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>foo <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    herr_t ret_value <span class="op">=</span> SUCCEED<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    FUNC_ENTER_NOAPI<span class="op">(</span>FAIL<span class="op">)</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    HDassert<span class="op">(</span><span class="co">/*parameter check*/</span><span class="op">);</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>H5X_other_call<span class="op">()</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        HGOTO_ERROR<span class="op">(</span>H5E_MAJ<span class="op">,</span> H5E_MIN<span class="op">,</span> FAIL<span class="op">,</span> <span class="st">"badness"</span><span class="op">);</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>done<span class="op">:</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret_value <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* do error cleanup */</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* do regular cleanup stuff */</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    FUNC_LEAVE_NOAPI<span class="op">(</span>ret_value<span class="op">);</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There are a couple of things to note here.</p>
<ul>
<li>Each function call has a header comment block. The information you’ll find in most function comments is not particularly helpful. We’re going to improve the format of this.</li>
<li>Most functions will return <code>herr_t</code> or <code>hid_t</code> ID. We try to avoid other return types and instead use out parameters to return things to the user.</li>
<li>The name will be of the form <code>H5X_do_something()</code> with one or two underscores after the <code>H5X</code>. The naming scheme will be explained later.</li>
<li>Even though C99 allows declarations anywhere in the function, we put most of them at the top of the file, with the exception of loop variables and variables that are “in scope” inside an ifdef.</li>
<li>We generally initialize values that may need to be freed or otherwise cleaned up to a “bad” value like <code>NULL</code> or <code>H5I_INVALID_HID</code> so we can better clean up resources on function exit, especially when there have been errors.</li>
<li>Most non-void functions will declare a variable called <code>ret_value</code>. This is used by the error handling macros. It’s usually the last thing declared in the variable block.</li>
<li>Every function starts with a <code>FUNC_ENTER macro</code>, discussed later in this document.</li>
<li>Most internal calls will check parameters via asserts.</li>
<li>We check the return value of any call that can return an error, using the form shown.</li>
<li>On errors, an error macro is invoked. These are described later in this document.</li>
<li>Any function that returns an error will have a <code>done</code> target. Most error macros jump to this location on errors.</li>
<li>We do most cleanup at the end of the function, after the <code>done</code> target. There are special <code>DONE</code> flavors of error macro that we use in post-<code>done</code> cleanup code to detect and report errors without loops.</li>
<li>Almost every function ends with a <code>FUNC_LEAVE</code> macro.</li>
</ul>
<p>And here’s an example of a public API call:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Doxygen stuff goes here</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>herr_t</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>H5Xdo_api_stuff<span class="op">(</span><span class="co">/*parameters*/</span><span class="op">)</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* variables go here */</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    herr_t ret_value <span class="op">=</span> SUCCEED<span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    FUNC_ENTER_API<span class="op">(</span>FAIL<span class="op">)</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    H5TRACE3<span class="op">(</span><span class="co">/*stuff*/</span><span class="op">)</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="co">/*parameter check*/</span><span class="op">)</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        HGOTO_ERROR<span class="op">(</span>H5E_ARGS<span class="op">,</span> H5E_BADVALUE<span class="op">,</span> FAIL<span class="op">,</span> <span class="st">"badness"</span><span class="op">);</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* VOL setup */</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>H5VL_call<span class="op">()</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        HGOTO_ERROR<span class="op">(</span>H5E_FOO<span class="op">,</span> H5E_BAR<span class="op">,</span> FAIL<span class="op">,</span> <span class="st">"badness"</span><span class="op">);</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>done<span class="op">:</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret_value <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* do error cleanup */</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* do regular cleanup stuff */</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    FUNC_LEAVE_API<span class="op">(</span>ret_value<span class="op">);</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A public API call differs little from an internal call. The biggest differences:</p>
<ul>
<li>Public API calls are commented using Doxygen. This is how we generate the reference manual entries.</li>
<li>The name will have the form <code>H5Xdo_stuff()</code>, with no underscores after the <code>H5X</code>.</li>
<li>The function enter macro is <code>FUNC_ENTER_API</code> (or similar). Under the hood, this one differs quite a bit from an internal function enter macro. It checks for package initialization, for example, and acquires the global lock in thread-safe HDF5.</li>
<li>There is a <code>TRACE</code> macro. This helps with API tracing and is applied by a script invoked by <code>autogen.sh</code> (Autotools) or CMake. You probably don’t need to worry much about this.</li>
<li>Parameter checking uses the regular HDF5 error scheme and invokes <code>HGOTO_ERROR</code> macros on errors.</li>
<li>In storage-related calls, there will usually be some VOL setup (HDF5 1.12.x and later) and in lieu of a regular internal API call, there will be an <code>H5VL</code> VOL call.</li>
<li>The function exit macro will be <code>FUNC_LEAVE_API</code> (or similar). This is where we release the global thread-safe lock, etc.</li>
</ul>
</section>
<section id="public-private-package" class="level3">
<h3 class="anchored" data-anchor-id="public-private-package">Public, private, package</h3>
<p>HDF5 is divided into <em>packages</em>, which encapsulate related functionality. Each has a prefix of the form <code>H5X(Y)</code>. An example is the dataset package, which has the prefix <code>H5D</code>. Hopefully, you are familiar with this from the public API. In addition to the public packages, we all know and love, there are many internal packages that are not visible to the public via API calls, like <code>H5FL</code> (free lists / memory pools) and <code>H5B2</code> (version 2 B-trees). There’s also an <code>H5</code> package that deals with very low-level things like library startup.</p>
<p>API calls, types, etc. in HDF5 have three levels of visibility. From most to least visible, these are:</p>
<ul>
<li>Public</li>
<li>Private</li>
<li>Package</li>
</ul>
<p><strong>Public</strong> things are in the public API. They are usually found in <code>H5Xpublic.h</code> header files. API calls are of the form <code>H5Xfoo()</code>, with no underscores between the package name and the rest of the function name.</p>
<p><strong>Private</strong> things are for use across the HDF5 library, and can be used outside the packages that contain them. They collectively make up the “internal library API”. API calls are of the form <code>H5X_foo()</code> with one underscore between the package name and the rest of the function name.</p>
<p><strong>Package</strong> things are for use inside the package and the compiler will complain if you include them outside of the package they belong to. They collectively make up the “internal package API”. API calls are of the form <code>H5X__foo()</code> with <em>two</em> underscores between the package name and the rest of the function name. The concept of “friend” packages exists and you can declare this by defining <code>&lt;package&gt;_FRIEND</code> in a file. This will let you include the package header from a package in a file that it is not a member of. Doing this is strongly discouraged, though. Test functions are often declared in package headers as they expose package internals and test programs can include multiple package headers so they can check on internal package state.</p>
<p>Note that the underscore scheme is primarily for API calls and does not extend to things like types and symbols. Another thing to keep in mind is that the difference between package and private API calls can be somewhat arbitrary. We’re hoping to improve the coherence of the internal APIs via refactoring.</p>
</section>
<section id="function-enter-and-leave-macros" class="level3">
<h3 class="anchored" data-anchor-id="function-enter-and-leave-macros">Function enter and leave macros</h3>
<p>Function enter and leave macros are added to almost all HDF5 API calls. This is where we set up error handling (see below) and things like the thread-safety global lock (in public API calls). There are different flavors depending on the API call and it’s very important that they are appropriate for the function they mark up.</p>
<p>The various combinations you are most likely to encounter:</p>
<table class="table">
<thead>
<tr class="header">
<th>Macro</th>
<th>Use</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>FUNC_ENTER_API</code></td>
<td>Used when entering a public API call</td>
</tr>
<tr class="even">
<td><code>FUNC_ENTER_NOAPI</code></td>
<td>Used when entering a private API call</td>
</tr>
<tr class="odd">
<td><code>FUNC_ENTER_PACKAGE</code></td>
<td>Used when entering a package API call</td>
</tr>
</tbody>
</table>
<p>There are also <code>_NO_INIT</code> flavors of some of these macros. These are usually small utility functions that don’t initialize the library, like <code>H5is_library_threadsafe()</code>. They are uncommon.</p>
<p>You may also come across <code>_NO_FS</code> (“no function stack”) flavors that don’t push themselves on the stack. These are rare.</p>
<p>For the most part, you will be using the <code>API</code>, <code>NOAPI</code>, and <code>PACKAGE</code> macros.</p>
<p>You may see other versions if you are working in a maintenance branch, like the <code>STATIC</code> macros that we removed in 1.13. We’ve been working to reduce the complexity and number of these macros and we don’t always push that downstream due to the scope of the changes involved. You should be able to figure out what any new macros do based on what you’ve seen here, though.</p>
</section>
<section id="error-macros" class="level3">
<h3 class="anchored" data-anchor-id="error-macros">Error macros</h3>
<p>Almost all HDF5 functions return an error code, usually -1 or some typedef’d equivalent. Functions that return <code>void</code> should be avoided, even if the function cannot fail. Instead, return an <code>herr_t</code> value and always return <code>SUCCEED</code>.</p>
<table class="table">
<thead>
<tr class="header">
<th>Type</th>
<th>Error Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>herr_t</code></td>
<td><code>FAIL</code></td>
</tr>
<tr class="even">
<td>any signed integer type</td>
<td>-1</td>
</tr>
<tr class="odd">
<td><code>hid_t</code></td>
<td><code>H5I_INVALID_HID</code></td>
</tr>
<tr class="even">
<td><code>htri_t</code></td>
<td><code>FAIL</code></td>
</tr>
<tr class="odd">
<td><code>haddr_t</code></td>
<td><code>HADDR_UNDEF</code></td>
</tr>
<tr class="even">
<td>pointer</td>
<td><code>NULL</code></td>
</tr>
</tbody>
</table>
<p>We’ve been trying to move away from using anything other than <code>herr_t</code> or <code>hid_t</code> to return errors, as eliminating half of a variable’s potential values just so we can return a ‘bad’ value on errors seems unwise in a library that is designed to scale.</p>
<p><code>herr_t</code> is a typedef’d signed integer. In the library, we only define two values for it: <code>SUCCEED</code> and <code>FAIL</code>, which are defined to 0 and -1, respectively, in <code>H5private.h</code>. We do not export these values, so public API calls just note that <code>herr_t</code> values will be negative on failure and non-negative on success.</p>
<p>Most of the error handling is performed using macros. The only extra setup you will have to do is:</p>
<ol type="1">
<li><p>Create a variable named <code>ret_value</code> with the same type as the return value for the function. If the type is <code>herr_t</code> it is frequently set to <code>SUCCEED</code> and will be set to <code>FAIL</code> on errors. In most other cases, the value is initialized to the ‘bad’ value and the function’s code will set <code>ret_value</code> to a ‘good’ value at some point, with errors setting it back to the ‘bad’ value.</p></li>
<li><p>Create a done target (<code>done:</code>) just before you start your error cleanup. This will be the point to which the error macros will jump.</p></li>
</ol>
<p>We check for errors on almost all internal lines of C code that could putatively fail. The general format is this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>function_that_could_fail<span class="op">(</span>foo<span class="op">,</span> bar<span class="op">)</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    HGOTO_ERROR<span class="op">(</span>H5E_<span class="op">&lt;</span>major<span class="op">&gt;,</span> H5E_<span class="op">&lt;</span>minor<span class="op">&gt;,</span> <span class="op">&lt;</span>bad value<span class="op">&gt;,</span> <span class="st">"tell me about badness"</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>HGOTO_ERROR</code> is one of a set of macros defined in <code>H5Eprivate.h</code>. This macro pops an error on the error stack and sets the return value to <code>&lt;bad value&gt;</code>, then jumps to the <code>done:</code> target.</p>
<p>Major and minor codes are a frequent cause of confusion. A full list of them can be found in <code>H5err.txt</code>, which is processed into the actual error header files at configure time by the <code>bin/make_err</code> script. The original intent was for major and minor error codes to be strongly associated. i.e., a given minor code would <em>only</em> be used with its associated major code. Unfortunately, this has not been the case in practice, and the emitted text can appear nonsensical in error stack dumps. Even worse, the major and minor error codes are used inconsitently throughout the library, making interpreting them almost impossible for external users. We hope to address this deficiency in the near future.</p>
<p>In the meantime, the following guidelines can be helpful:</p>
<ol type="1">
<li>Use <code>H5E_ARGS</code> as the major error category when parsing function parameters. The minor code will usually be <code>H5E_BADVALUE</code>, <code>H5E_BADRANGE</code>, or <code>H5E_BADTYPE</code>.</li>
<li>Otherwise use the same major code throughout the source file. There is almost a 1-1 correspondence between packages and major error codes.</li>
<li>Pick the minor code that seems to match the API call. You can grep through the library to find similar uses.</li>
<li>The string at the end of the <code>HGOTO_ERROR</code> macro is much more important, so make sure that is helpful</li>
</ol>
<p>You will still sometimes see the major error code match the package of a failing function call. We’re trying to fix those as we come across them.</p>
<p>Since the <code>HGOTO_ERROR</code> macro jumps to the <code>done:</code> target, you can’t use it after the <code>done:</code> target without creating a loop. Instead, you’ll need to use the <code>HDONE_ERROR</code> macro, which will handle errors without jumping to the target. Instead, processing will continue after pushing the error and setting the return value, in the hopes that we can clean up as much as possible.</p>
<p>At the end of the function, the <code>FUNC_LEAVE</code> macro will return <code>ret_value</code>.</p>
</section>
<section id="trace-macros" class="level3">
<h3 class="anchored" data-anchor-id="trace-macros">Trace macros</h3>
<p>These are automatically generated for public C library API calls by the <code>bin/trace</code> script, which scans the source code, looking for functions of the form <code>H5X(Y?)&lt;whatever&gt;()</code>, to which it will add or update the <code>H5TRACE</code> macros.</p>
<p><code>H5TRACE</code> macros are only added to public C library API calls. They are NOT added to the language wrappers, tools code, high-level library, etc.</p>
<p>You should never have to modify an <code>H5TRACE</code> macro. Either point <code>bin/trace</code> at your source file or run <code>autogen.sh</code> (which runs <code>bin/trace</code> over the C files in <code>src</code>). <code>bin/trace</code> is a Perl script, so you’ll need to have that available.</p>
</section>
<section id="memory---h5mm-and-h5fl" class="level3">
<h3 class="anchored" data-anchor-id="memory---h5mm-and-h5fl">Memory - <code>H5MM</code> and <code>H5FL</code></h3>
<p>In the C library itself, we use <code>H5MM</code> and <code>H5FL</code> calls to allocate and free memory instead of directly using the standard C library calls.</p>
<p>The <code>H5MM</code> package was originally designed so that it would be easy to swap in a memory allocator of the developer’s choosing. In practice, this has rarely been a useful feature, and we are thinking about removing this scheme. In the meantime, almost all memory allocations in the C library will use the <code>H5MM</code> (or <code>H5FL</code>) package.</p>
<p>In the past, we added memory allocation sanity checking to the <code>H5MM</code> calls which added heap canaries to memory allocations and performed sanity checking and gathered statistics. These were turned on by default in debug builds for many years. Unfortunately, there is interplay between library-allocated and externally-allocated memory in the filter pipeline where the heap canaries can easily get corrupted and cause problems. We also have some API calls that return library-allocated memory to the user, which can cause problems if they then use <code>free(3)</code> to free it. Given these problems, we now have the sanity checks turned off by default in all build modes. You can turn them back on via configure/CMake options, but it’s normally easier to use external tools like valgrind or the compiler’s memory debugging options.</p>
<p><code>H5FL</code> provides memory pools (<em>Free Lists</em>) that create a set of fixed-size allocations of a certain type that the library will re-use as needed. They use <code>H5MM</code> calls under the hood and can be useful when the library creates and frees a lot of objects of that type. It’s difficult to give a good guideline as to when to use the <code>H5FL</code> calls and when to use the <code>H5MM</code> calls, but it’s probably best to lean towards <code>H5MM</code> unless you can identify a clear performance hit due to memory cycling. Current library usage can be a good guide, but keep in mind that the free lists are probably overused in the library. Another thing to keep in mind is that the free lists can hide memory errors, like use-after-free. Some developers always turn them off and you’ll need to turn them off when running memory checkers like valgrind.</p>
<p>Using free list calls differs little from using <code>H5MM</code> calls. There are equivalents for <code>malloc(3)</code>, <code>calloc(3)</code>, and <code>free(3)</code>:</p>
<table class="table">
<thead>
<tr class="header">
<th>C Library</th>
<th><code>H5FL</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>malloc</code></td>
<td><code>H5FL_MALLOC</code></td>
</tr>
<tr class="even">
<td><code>calloc</code></td>
<td><code>H5FL_CALLOC</code></td>
</tr>
<tr class="odd">
<td><code>free</code></td>
<td><code>H5FL_FREE</code></td>
</tr>
</tbody>
</table>
<p>Since free lists provide pre-allocated memory of a fixed size, you can’t reallocate free list memory and there’s no <code>H5FL</code> <code>realloc(3)</code> equivalent.</p>
<p>You’ll also need to add a setup macro to the top of the file. There are a few flavors defined in <code>H5FLprivate.h</code>. Each creates global free list variables, so there are flavors for extern, static, etc.</p>
<table class="table">
<colgroup>
<col style="width: 41%">
<col style="width: 58%">
</colgroup>
<thead>
<tr class="header">
<th>Macro</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>H5FL_DEFINE</code></td>
<td>Define a free list that will be used in several files</td>
</tr>
<tr class="even">
<td><code>H5FL_EXTERN</code></td>
<td>Define a free list that was defined in another file</td>
</tr>
<tr class="odd">
<td><code>H5FL_DEFINE_STATIC</code></td>
<td>Define a free list that will only be used in this file</td>
</tr>
</tbody>
</table>
<p>You will also see <code>ARR</code>, <code>BLK</code>, <code>SEQ</code>, and <code>FAC</code> flavors of the macros. Their use is beyond the scope of a guide for beginners.</p>
</section>
</section>
<section id="testing" class="level2">
<h2 class="anchored" data-anchor-id="testing">Testing</h2>
<section id="two-macro-schemes" class="level3">
<h3 class="anchored" data-anchor-id="two-macro-schemes">Two macro schemes</h3>
<p>The HDF5 C library is tested via a collection of small programs in the <code>test/</code> directory. There are a few schemes in use:</p>
<ul>
<li><code>testhdf5</code> - A larger, composite test program composed of several test files, most of which start with ‘t’ (e.g., <code>tcoords.c</code>)</li>
<li>Shell/Powershell scripts that test things like SWMR and flush/refresh behavior. These scripts run small sub-programs.</li>
<li>Everything else. These are self-contained test programs that are built and run independently by the test harness.</li>
</ul>
<p>The test programs do not use a standard test framework like cppunit, but instead use HDF5-specific macros to set up the tests and report errors. There are two sets of macros, one in <code>testhdf5.h</code> and another in <code>h5test.h</code>. Originally, the <code>testhdf5</code> programs used the macros in <code>testhdf5.h</code> and everything else used the macros in <code>h5test.h</code>, but over time the tests have evolved so that all tests usually include both headers.</p>
<p>This is unfortunate, because it’s very important to not mix up the “test framework macros” in each scheme. The <code>testhdf5.h</code> macros register errors by setting global variables and normally continue with the test when they encounter errors. The <code>h5test.h</code> macros indicate errors by jumping to an error target and returning a <code>FAIL</code> <code>herr_t</code> value. If you combine these two macro sets, you may accidentally create tests that fail but do not register the failure.</p>
<p>We are aware that our testing scheme needs some work and we’ll be working to improve it over the next year or so.</p>
<p>The command-line tools are tested using a different scheme and are discussed elsewhere.</p>
</section>
<section id="testhdf5.h" class="level3">
<h3 class="anchored" data-anchor-id="testhdf5.h"><code>testhdf5.h</code></h3>
<p>The macros in this file are almost exclusively used in the <code>testhdf5</code> program. They register errors by incrementing a global error count that is inspected at the end of each test (not each test <em>function</em>, but each <em>test</em> - e.g., after <code>test_file()</code> in <code>tfile.c</code> runs, but not when the individual functions it calls run).</p>
<p>Test functions generally look like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>test_something<span class="op">()</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Variables go here */</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> out <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    herr_t ret<span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    MESSAGE<span class="op">(</span><span class="dv">5</span><span class="op">,</span> <span class="op">(</span><span class="st">"Testing a thing</span><span class="sc">\n</span><span class="st">"</span><span class="op">));</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> H5Xsome_api_call<span class="op">(&amp;</span>out<span class="op">);</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    CHECK<span class="op">(</span>ret<span class="op">,</span> FAIL<span class="op">,</span> <span class="st">"H5Xsome_api_call()"</span><span class="op">);</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    VERIFY<span class="op">(</span>out<span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="st">"incorrect value for out"</span><span class="op">);</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>MESSAGE</code> macro just dumps the name of what we’re testing when we’ve the verbosity cranked up. The confusingly-named <code>CHECK</code> and <code>VERIFY</code> macros are members of a suite of check macros in <code>testhdf5.h</code>. <code>CHECK</code> macros check to see if a variable is <strong>NOT</strong> a value, <code>VERIFY</code> macros check to see if a variable <strong>IS</strong> a value. There are different flavors of macro to match different types so be sure to use the right one to avoid compiler warnings and spurious errors. Under the hood, these macros will emit error information and increment the global error variables.</p>
<p>Tests are added to <code>testhdf5</code> in <code>testhdf5.c</code> using the <code>AddTest()</code> call. Each test will have a driver function, usually named something like <code>test_&lt;thing&gt;()</code> that invokes the test functions in the file. Most tests will cleanup their files using a <code>cleanup_&lt;thing&gt;()</code> call. If you are deleting HDF5 files, you should use <code>H5Fdelete()</code> instead of <code>remove(3)</code> so that files can be cleaned even when they use alternative VFDs or VOL connectors. You’ll also need to add prototypes for any new test driver or cleanup functions to <code>testhdf5.h</code>.</p>
<p>Because these macros interact with global variables that are only used in the testhdf5 program, they are useless anywhere else in the library. Even worse, it will <em>look</em> like you are testing functionality, but errors will not be picked up by the non-testhdf5 programs, hiding problems.</p>
</section>
<section id="h5test.h" class="level3">
<h3 class="anchored" data-anchor-id="h5test.h"><code>h5test.h</code></h3>
<p>These are the most commonly used macros and are used throughout the test code, even in places that are not specifically tests. Unlike the scheme used in the <code>testhdf5</code> program, these macros work more like the library, jumping to an <code>error:</code> target on errors. There is no common <code>ret_value</code> variable, however.</p>
<p>Test functions will usually look like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> herr_t</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>test_something<span class="op">()</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    hid_t fapl_id <span class="op">=</span> H5I_INVALID_HID<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    hid_t fid <span class="op">=</span> H5I_INVALID_HID<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> filename<span class="op">[</span><span class="dv">1024</span><span class="op">];</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>buf <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    TESTING<span class="op">(</span><span class="st">"Testing some feature"</span><span class="op">);</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>fapl_id <span class="op">=</span> h5_fileaccess<span class="op">())</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        TEST_ERROR<span class="op">;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    h5_fixname<span class="op">(</span>FILENAME<span class="op">[</span><span class="dv">0</span><span class="op">],</span> fapl<span class="op">,</span> filename<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>filename<span class="op">));</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>fid <span class="op">=</span> H5Fcreate<span class="op">(</span>filename<span class="op">,</span> H5F_ACC_TRUNC<span class="op">,</span> H5P_DEFAULT<span class="op">,</span> fapl_id<span class="op">))</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        TEST_ERROR<span class="op">;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Many more calls here */</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    PASSED<span class="op">();</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> SUCCEED<span class="op">;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>error<span class="op">:</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    HDfree<span class="op">(</span>buf<span class="op">);</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    H5E_BEGIN_TRY</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        H5Fclose<span class="op">(</span>fid<span class="op">);</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    H5E_END_TRY</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> FAIL<span class="op">;</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Tests begin with a <code>TESTING</code> macro that emits some text (unlike the <code>testhdf5</code> case, this is always dumped). Any errors will be handled by one of the <code>TEST_ERROR</code> macros. For the most part, <code>TEST_ERROR</code> will suffice, but there are others in <code>h5test.h</code> if you want to emit custom text, dump the HDF5 error stack when it would not normally be triggered, etc.</p>
<p>Most tests will be set up to run with arbitrary VFDs. To do this, you set the fapl ID using the <code>h5_fileaccess()</code> function, which will check the <code>HDF5_DRIVER</code> environment variable and set the fapl’s VFD accordingly. The <code>h5_fixname()</code> call can then be used to get a VFD-appropriate filename for the <code>H5Fcreate()</code>, etc. call.</p>
<p>In the <code>error</code> section, we clean up resources and return a ‘bad’ value, which will usually either be <code>FAIL</code> or -1.</p>
<p>The <code>main()</code> function of each test program will usually start out by calling <code>h5_reset()</code>, then run each test, incrementing an error count variable if a test fails. The exit code and text will be set based on the error count.</p>
</section>
<section id="scripts" class="level3">
<h3 class="anchored" data-anchor-id="scripts">Scripts</h3>
<p>If you need to fire off multiple programs to test a new feature, you may have to do this via a script. These are normally named <code>test_&lt;thing&gt;.sh.in</code>. The <code>.in</code> is because the scripts are often modified and copied during the configure step. In the past, we have tried to stick to POSIX Bourne shell scripts, but many scripts now require bash.</p>
<p>If you write a new test script, it is important to also add a PowerShell equivalent for testing on Windows.</p>
<p>It’s helpful to run any new shell scripts through <code>shellcheck</code> (https://www.shellcheck.net/) to ensure that your scripts are free from common problems.</p>
</section>
<section id="parallel-tests-in-testpar" class="level3">
<h3 class="anchored" data-anchor-id="parallel-tests-in-testpar">Parallel tests (in <code>testpar/</code>)</h3>
<p>To be covered in a future update of this guide…</p>
</section>
<section id="adding-new-tests" class="level3">
<h3 class="anchored" data-anchor-id="adding-new-tests">Adding new tests</h3>
<p>All new HDF5 library functionality (including bugfixes) should have a test. Some rules of thumb:</p>
<ul>
<li>If you need to run multiple programs, you’ll need to create a script and some test programs. Use the macros in <code>h5test.h</code> to handle errors in your test programs.</li>
<li>If a suitable test program already exists (especially if your tests will be small), add your new tests to the existing file.</li>
<li>If you need to create a new test program, create one that uses the <code>h5test.h</code> macros.</li>
<li>Avoid adding new tests to <code>testhdf5</code> or using the macros in <code>testhdf5.h</code>.</li>
</ul>
<p>Don’t forget that you’ll need to add your test program or script to the lists in both the CMake and Autotools test files (<code>CMakeLists.txt</code> and <code>Makefile.am</code> in <code>test/</code> respectively). For simple tests, you just need to add your new test to the list of tests.</p>
<p>All new tests <strong>MUST</strong> run under both the Autotools and CMake. Ideally, they should also work on Windows, but we’re willing to overlook this for things that are unlikely to be useful on that platform.</p>
</section>
</section>
<section id="documentation" class="level2">
<h2 class="anchored" data-anchor-id="documentation">Documentation</h2>
<p>We have moved the user guide and reference manual to Doxygen. All public API calls and symbols should have Doxygen markup in the public header file. New major features should be documented in the user guide. This Doxygen content is located in the package’s module header file (<code>H5Xmodule.h</code>). Language wrapper calls (C++/Fortran/Java) should also have Doxygen markup, which will be located with the wrapper source code. Images and other common Doxygen files belong in the <code>doxygen</code> directory.</p>
<p>Internal documentation for developer consumption is currently stored as Markdown files in the <code>doc</code> directory. This may change in the future. Documentation that helps understand the contents of a directory is often stored in a README.md Markdown file in that directory.</p>
<p>Build and install documentation is stored in text files in <code>release_docs</code>. This is admittedly not the best place for this. History files are also kept here.</p>
</section>
<section id="command-line-tools" class="level2">
<h2 class="anchored" data-anchor-id="command-line-tools">Command-Line Tools</h2>
<p>The HDF5 command-line tools are written in C and built with the library by default. The code is organized into a central tools library (in the <code>tools/lib</code> directory) that includes some common functionality and the individual programs, each of which has its own directory in <code>tools/src</code>. A few of the smaller tools are aggregated into the <code>tools/src/misc</code> directory. Only h5diff has a parallel version at this time and the parallel-specific functionality is in the <code>tools/src/h5diff/ph5diff_main.c</code> file. Some h5diff functionality has also made its way into the tools library. The tools code is not as well organized as the main library, so there’s more opportunity for refactoring here.</p>
<p>Also worth noting is that the command-line tools only use <strong>public</strong> HDF5 API calls, even though they include <code>H5private.h</code> in order to take advantage of the platform-independence scheme we use in the main library and some private utility functions.</p>
<p>There are also a few tools in the high-level library. The gif2h5 and h52gif tools are poorly-written and have known security issues, so they will soon be moved to a separate repository, leaving h5watch as the only high-level command-line tool.</p>
<section id="source-code" class="level3">
<h3 class="anchored" data-anchor-id="source-code">Source code</h3>
<p>The source code for the tools likes more like standard C code and uses its own set of macros, which are defined in the tools library header files. There are no <code>FUNC_ENTER</code> macros, you do not need to define a <code>ret_value</code> variable, and the error macros are greatly simplified. Errors are usually handled by a <code>TOOLS_ERROR</code> macro (or <code>TOOLS_GOTO_ERROR</code> if you need to jump to a <code>done:</code> target to handle cleanup). One area where the tools need a lot more work is in handling errors. The tools code frequently ignores errors, often in functions that return <code>void</code>.</p>
<p>A “tools-only” consideration is the use of command-line arguments. We try to be conservative about these, even though they really aren’t in the “public API” in the same way as API calls are. Additions and changes to the options will probably result in some discussion.</p>
</section>
<section id="tools-tests" class="level3">
<h3 class="anchored" data-anchor-id="tools-tests">Tools tests</h3>
<p>In most cases, a tool will be run against an input HDF5 file with a particular set of command-line parameters, the exit code checked, and the output compared with a standard output file. In some cases, errors are expected and standard error files will be compared. These standard error files often contain HDF5 error stack dumps, which can cause spurious tool test “failures” when we make changes to the main HDF5 C library.</p>
<p>Test files can be located in a few places in the <code>tools</code> directory tree. Common input files that are used with multiple tools are kept in <code>tools/testfiles</code>. Input files that are used with just one tool are located in <code>tools/test/&lt;tool&gt;/testfiles</code>. Expected output files are located with their respective HDF5 files and end in <code>.txt</code>. Expected error files are also located with their respective HDF5 files and end in <code>.err</code>. h5dump files will usually have <code>.ddl</code> and <code>.xml</code> output files and there will usually be <code>.&lt;tool&gt;</code> files that contain help output. The test files are generated by programs with <code>gentest</code> in their name, though we typically check the generated HDF5 files in instead of recreating them as a part of running the tools tests.</p>
<p>The Autotools aggregate the tools tests in per-tool shell scripts in the <code>tools/test/&lt;tool&gt;</code> directory. Each script starts with a few utility functions that perform setup, compare files, clean output, etc. and the test commands will appear at the end. CMake works similarly, but each test is set up in the CMakeLists.txt and CMakeTests.cmake files in the same directory.</p>
<p>Adding a new test will usually involve: - Adding a new function to the appropriate generator program to create a new HDF5 file - Adding your new test to the CMake and Autotools test scripts, as described above - Adding appropriate output and/or error files for comparison</p>
<p>You MUST add new tests to both the Autotools and CMake.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Contact : <a href="mailto:correa@mbd.rwth-aachen.de"><strong>Alan Correa</strong></a>, <a href="mailto:steldermann@mbd.rwth-aachen.de"><strong>Ingo Steldermann</strong></a></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p><a href="https://www.mbd.rwth-aachen.de"><img src="../../../docs/images/logo_mbd.png" class="img-fluid" alt="MBD" width="200"></a></p>
</div>
  </div>
</footer>




</body></html>